<VirtualHost *:<%= @params[:server_port] || node['apache']['listen_ports'].first %>>
  ServerName <%= @params[:server_name] %>
  DocumentRoot <%= @params[:docroot] %>

  <Directory <%= @params[:docroot] %>>
    Options <%= [@params[:directory_options] || "FollowSymLinks" ].flatten.join " " %>
    AllowOverride <%= [@params[:allow_override] || "None" ].flatten.join " " %>
  <% if node['apache']['version'] == '2.4' -%>
    Require all granted
  <% else -%>
    Order allow,deny
    Allow from all
  <% end -%>
  </Directory>

  <Directory />
    Options FollowSymLinks
    AllowOverride None
  </Directory>

  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined

  RewriteEngine on
  RewriteCond %{SERVER_PORT} !^443$
  RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [NC,R=301,L]
  
</VirtualHost>

<VirtualHost _default_:443>
  DocumentRoot <%= @params[:docroot] %>
  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined

  SSLEngine on
  SSLCertificateFile  /etc/ssl/<%= node['mattermost']['config']['server_name'] %>.crt
  SSLCertificateKeyFile /etc/ssl/<%= node['mattermost']['config']['server_name'] %>.key

  <FilesMatch "\.(cgi|shtml|phtml|php)$">
      SSLOptions +StdEnvVars
  </FilesMatch>

  <Directory /usr/lib/cgi-bin>
      SSLOptions +StdEnvVars
  </Directory>

  BrowserMatch "MSIE [2-6]" \
      nokeepalive ssl-unclean-shutdown \
      downgrade-1.0 force-response-1.0
  BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

  <Proxy *>
    Require all granted
  </Proxy>
  
  ProxyPass        / http://localhost:8065/ connectiontimeout=5 timeout=300
  ProxyPassReverse / http://localhost:8065/

</VirtualHost>
